<!DOCTYPE HTML>
<html lang="id" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Feature 2 - workshop-nodejs</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded "><a href="start.html"><strong aria-hidden="true">1.</strong> Start</a></li><li class="expanded "><a href="feature_design.html"><strong aria-hidden="true">2.</strong> Features &amp; Design</a></li><li class="expanded "><a href="hacking.html"><strong aria-hidden="true">3.</strong> Hacking!!</a></li><li><ol class="section"><li class="expanded "><a href="feature_1.html"><strong aria-hidden="true">3.1.</strong> Feature 1</a></li><li class="expanded "><a href="feature_2.html" class="active"><strong aria-hidden="true">3.2.</strong> Feature 2</a></li><li class="expanded "><a href="feature_3.html"><strong aria-hidden="true">3.3.</strong> Feature 3</a></li></ol></li><li class="expanded "><a href="exercise.html"><strong aria-hidden="true">4.</strong> Exercises</a></li><li class="expanded "><a href="bonus.html"><strong aria-hidden="true">5.</strong> Bonus</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">workshop-nodejs</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#feature-2" id="feature-2">Feature 2</a></h1>
<blockquote>
<p>Sebagai pemilik platform berita hanya dapat ditulis/diubah oleh pengguna yg terotorisasi</p>
</blockquote>
<p>Kita perlu mekanisme auth nih. Cara yg umum digunakan adalah token based auth. Dinama authentikasi dan authorisisai akan menggunakan token. Token ini sendiri bisa berupa string yang merepresentasikan data pengguna.</p>
<p>Kita akan buat token dengan jwt. Install dulu dependensi berikut</p>
<pre><code>npm i jsonwebtoken
</code></pre>
<pre><code class="language-js">// service/auth.js

var jwt = require('jsonwebtoken');

const secretKey = 'secret'

exports.sign = (user) =&gt; {
    if (user.password) {
        delete user.password
    }

    return jwt.sign(user, secretKey);
}

// return decoded token
exports.verfiy = (token) =&gt; {
    try {
        return jwt.verify(token, secretKey);
    } catch(err) {
        console.error(err)
        return false
    }
}

module.exports = exports
</code></pre>
<p>Untuk fitur login kita akan menggunakan username dan password dan mengembalikan jtw token
langsung saja kita buat repository untuk find by username nya. Krn hasil query mysql itu adalah sebuah class, kita perlu mentransform ke bentuk plain object.
Kita akan buat juga utility untuk transformasi nya</p>
<pre><code class="language-js">// repository/utils.js
exports.objectifyRawPacket = row =&gt; ({...row});

module.exports = exports
</code></pre>
<pre><code class="language-js">// repository/user_repository.js
...
exports.findByUsername = (username) =&gt; new Promise((resolve, reject) =&gt;{
    pool.getConnection((err, conn) =&gt; {
        if (err) {
            reject(err)
            return
        }

        conn.query(`SELECT * FROM users WHERE username = ?`, [username], (err, res) =&gt; {
            conn.release()

            if (err) {
                console.error(err)
                reject(err)
                return
            }

            if (res.size == 0) {
                resolve(null)
                return
            }

            let obj = utils.objectifyRawPacket(res[0])
            console.log(obj)
            resolve(obj)
        })
    })
})
...
</code></pre>
<p>Lalu, kita buat auth_service nya</p>
<pre><code class="language-js">//  service/auth_service.js
const userRepo = require('../repository/user_repository.js')
const auth = require('./auth.js')

const Router = require('express').Router
const r = Router()

r.post(&quot;/login&quot;, async (req, res) =&gt; {
    try {
        const { username, password } = req.body
        const user = await userRepo.findByUsername(username)
        if (!user || (user.password != password)) {
            return res.status(404).json({&quot;message&quot;: &quot;user not found&quot;})
        }

        const token = auth.sign(user)
        return res.json(token)
    } catch (err) {
        console.error(err)
        res.status(403).json({&quot;message&quot;: &quot;unauthenticated&quot;})
        return
    }
})

module.exports = r
</code></pre>
<p>Lalu, kita tambahkan ke service</p>
<pre><code class="language-js">const authService = require('./auth_service') // import authService
...
app.use(&quot;/users&quot;, userService)
app.use(&quot;/auth&quot;, authService) // tambahkan di sini
...
</code></pre>
<p>Kita coba saja langsung di POSTMAN. Kalau sudah berhasil harusnya ada balikan token.
Token itu bisa dicek hasilnya dari verify.</p>
<pre><code class="language-js">// test.js
const auth = require('./service/auth')
const decoded = auth.verfiy(`eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6OCwidXNlcm5hbWUiOiJqb2huIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTgzNTA1NjQ1fQ.R7zMh8iLMau5q_yagjhFYYAtyqKLKP4B_KShh_rPjvQ`)

console.log(decoded)
</code></pre>
<h3><a class="header" href="#content" id="content">Content</a></h3>
<p>Oke, sekarang kita akan membuat <code>content</code>, pertama kita tambahkan migration nya dulu.
Tambahkan <code>createTableContent</code> setelah <code>createTableUser</code> pada fungsi <code>migrate</code>. </p>
<pre><code class="language-js">let createTableContent = `
    CREATE TABLE IF NOT EXISTS contents (
        id INT NOT NULL AUTO_INCREMENT,
        author_id INT NOT NULL,
        title TEXT,
        slug VARCHAR(3072),
        body TEXT,
        CONSTRAINT contents_slug_unique UNIQUE (slug),
        PRIMARY KEY (id)
    )
`

utils.migrate([createTableUser, createTableContent])
</code></pre>
<p>Selanjutnya kita perlu membuat, repo nya. Tambahkan kode berikut</p>
<pre><code class="language-js">// repository/content_repository.js
const mysql = require('../db/mysql')

exports.create = ({ author_id = 0, title = '', body = '' }) =&gt; {
    return new Promise((resolve, reject) =&gt; {
        pool.getConnection((err, conn) =&gt; {
            if (err) {
                console.error(err)
                reject(err)
                return
            }

            // slug ini harus dibuat unique
            const slug = createUniqueSlug(title)

            const q = `INSERT INTO contents (author_id, title, body, slug) VALUES(?, ?, ?, ?)`
            conn.query(q, [author_id, title, body, slug], (err, res) =&gt; {
                conn.release()

                if (err) {
                    console.error(err)
                    reject(err)
                    return
                }

                const id = res.insertedId
                resolve({ id, author_id, title, body, slug })
            })
        })
    })
}
</code></pre>
<p>Untuk membuat slug kita bisa menggunakan module <code>slugify</code>.</p>
<pre><code>npm i slugify
</code></pre>
<p>Lalu, kita buat fungsi <code>createUniqueSlug</code>, agar slug bisa selalu unique, kita akan tambahkan unix timestamp di akhir slug.</p>
<pre><code class="language-js">// repository/content_repository.js

const slugify = require('slugify')
...
const createUniqueSlug = (text) =&gt; {
    const unique = (new Date()).getTime()
    return slugify(text, '-') + '-' + unique
}
...
</code></pre>
<p>Kita bisa coba dulu di file <code>test.js</code></p>
<pre><code class="language-js">const contentRepo = require('./repository/content_repository')
contentRepo.create({ author_id: 8, title: 'my first story', body: 'body of my first story'})
        .then(content =&gt; {
            console.log(content)
        })
        .catch(err =&gt; {
            console.error(err)
        })
        .finally(() =&gt; {
            process.exit(0)
        })
</code></pre>
<p>Sip, jika sudah berhasil, kita akan buat service nya.</p>
<pre><code class="language-js">// service/content_service.js

const userRepo = require('../repository/user_repository.js')
const contentRepo = require('../repository/content_repository.js')

const Router = require('express').Router
const r = Router()

r.post(&quot;/&quot;, async (req, res) =&gt; {
    try {
        const { content } = req.body
        // TODO: add validation

        // check is user exists ?
        const user = await userRepo.findByID(content.author_id)
        if (!user || !user.id) {
            return res.status(404).json({&quot;message&quot;: &quot;author not found&quot;})
        }

        const newContent = await contentRepo.create(content)
        if (!newContent) {
            return res.status(400).json({&quot;message&quot;: &quot;failed&quot;})
        }
    
        return res.json(newContent)   
    } catch (err) {
        console.error(err)
        return res.status(500).json({ &quot;message&quot;: &quot;something wrong&quot; })
    }
})

module.exports = r
</code></pre>
<p>Kita tambahkan <code>content_service</code> ke main router</p>
<pre><code class="language-js">...
const contentService = require('./content_service')
...
app.use(&quot;/contents&quot;, contentService)
...
</code></pre>
<p>Wait, masih ada yang kurang, seharusnya hanya &quot;user&quot; yang boleh membuat content. Untuk itu kita perlu melakukan otentikasi client yang melakukan <code>create content</code>.</p>
<p>Kita perlu sebuah middleware untuk melakukan otentikasi. Untuk otentikasi kita akan menggunakan header <code>Authorization</code> dengan value <code>Bearer &lt;YourToken&gt;</code>. </p>
<blockquote>
<p>client ---&gt; middleware (bisa melakukan pencegatan untuk autentikasi) --&gt; router</p>
</blockquote>
<pre><code class="language-js">// service/middleware.js

const auth = require('./auth.js')

exports.authenticate = (req, res, next) =&gt; {
    const bearerHeader = req.headers['authorization'];
    if (!bearerHeader) {
        // Forbidden
        return res.sendStatus(403);
    }

    const bearer = bearerHeader.split(' ');
    if (bearer.length != 2) {
        return res.status(403).json({&quot;message&quot;: &quot;invalid token&quot;});
    }

    const bearerToken = bearer[1];
    const token = bearerToken;
    try {
        const decoded = auth.verfiy(token)
        if (!req.context) {
            req.context = {}
        }
    
        req.context.user = decoded  
        next();
    } catch (err) {
        console.error(err)
        return res.sendStatus(403)
    }
}

module.exports = exports
</code></pre>
<p>Lalu, kita pasang middleware tersebut ke content_service post</p>
<pre><code class="language-js">const middleware = require('./middleware.js')
...
r.post(&quot;/&quot;, middleware.authenticate, async (req, res) =&gt; {...}
</code></pre>
<p>Next, kita akan melakukan update content. Untuk update content hanya dapat dilakukan oleh author nya saja dengan kata lain kita perlu cek autorisasi. Kita buat router nya dengan method PUT</p>
<pre><code class="language-js">...
r.put(&quot;/&quot;,  middleware.authenticate, async(req, res) =&gt; {
    try {
        const { content } = req.body
        // TODO: add validation

        const { user } = req.context

        // check if content exists
        const oldContent = await contentRepo.findByID(content.id)
        if (!oldContent) {
            return res.status(404).json({&quot;message&quot;: &quot;content not found&quot;})
        }

        // not the same user
        if (!user || (user.id !== oldContent.author_id)) {
            return res.status(404).json({&quot;message&quot;: &quot;author not found&quot;})
        }

        const updatedContent = await contentRepo.update(content)
        if (!updatedContent) {
            return res.status(400).json({&quot;message&quot;: &quot;failed&quot;})
        }
    
        return res.json(updatedContent)   
    } catch (err) {
        console.error(err)
        return res.status(500).json({&quot;message&quot;: &quot;something wrong&quot;})
    }
})
...
</code></pre>
<p>Kita juga perlu menambahkan update di content_repository</p>
<pre><code class="language-js">// repository/content_repository.js
exports.update = ({ id = 0, author_id = 0, title = '', body = '' }) =&gt; {
    return new Promise((resolve, reject) =&gt; {
        pool.getConnection((err, conn) =&gt; {
            if (err) {
                console.error(err)
                reject(err)
                return
            }

            // slug ini harus dibuat unique
            const slug = createUniqueSlug(title)

            const q = `UPDATE contents SET author_id = ?, title = ?, body = ?, slug = ? WHERE id = ?`
            conn.query(q, [author_id, title, body, slug, id], (err, res) =&gt; {
                conn.release()

                if (err) {
                    console.error(err)
                    reject(err)
                    return
                }

                resolve({ id, author_id, title, body, slug })
            })
        })
    })
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="feature_1.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="feature_3.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="feature_1.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="feature_3.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
